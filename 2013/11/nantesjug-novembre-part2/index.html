
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Soirée JUG Nantes : Du SQL au NoSQL en moins d'une heure (Partie 2) - Rossi Oddet</title>
  <meta name="author" content="Rossi Oddet">

  
  <meta name="description" content="Vous pouvez retrouvez la première partie de cet article ici. Le 04 novembre dernier, Tugdual Grall et David Pilato ont offert au public nantais une &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://roddet.github.com/2013/11/nantesjug-novembre-part2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Rossi Oddet" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32190657-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>	
  <h1><a href="/">Rossi Oddet</a></h1>
  
    <h2>Blog d'un artisan développeur</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:roddet.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/events">Evénements</a></li>
  <li><a href="/viededev">Vie de Développeur</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Soirée JUG Nantes : Du SQL Au NoSQL en Moins D'une Heure (Partie 2)</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-21T09:30:00-05:00" pubdate data-updated="true">Nov 21<span>st</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Vous pouvez retrouvez la première partie de cet article <a href="http://blog.roddet.com/2013/11/nantesjug-novembre-part1/">ici</a>.</p>

<p>Le 04 novembre dernier, <a href="https://twitter.com/tgrall">Tugdual Grall</a> et <a href="https://twitter.com/dadoonet">David Pilato</a> ont offert au public nantais une preview d&#8217;une session qu&#8217;ils allaient donner quelques jours plus tard à <a href="http://www.devoxx.be/dv13-david-pilato.html?presId=3281">Devoxx Belgique</a>. Ils vont montrer, sur la base d&#8217;une application exemple, une migration du SQL au monde du NoSQL.</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-david-pilato-tugdual-grall.jpg"></p>

<h2>Pourquoi passer du SQL au NoSQL ?</h2>

<p><a href="https://twitter.com/tgrall">Tugdual</a> et <a href="https://twitter.com/dadoonet">David</a> vont commencer la session par présenter <em>LA</em> raison qui pourrait vous convaincre de migrer d&#8217;une base SQL à une base NoSQL : la scalabilité horizontale.</p>

<p>Scalabilité horizontale sont les mots à la mode pour désigner la caractéristique d&#8217;un système capable de supporter une grande charge. Pour augmenter la puissance d&#8217;un système, sa stratégie consiste à multiplier le nombre de machines de petites puissances. Elle se positionne en opposition à la scalabilité verticale qui prône l&#8217;augmentation des capacités d&#8217;une machine pour répondre à des besoins de charge croissants.</p>

<p>La scalabilité horizontale s&#8217;impose de plus en plus comme <em>LA</em> solution pour relever le défi des systèmes performants à fort trafic.</p>

<p>Peut-on effectuer la scalabilité horizontale avec une base de données relationnelle ?</p>

<p>La réponse est oui. Ca s&#8217;appelle mettre en place un <em>cluster de base de données</em>. Tug et David vont demander aux participants combien avaient déjà configuré un <em>cluster</em> de bases de données relationnelles ? Je n&#8217;ai vu qu&#8217;une seule main levée de là où j&#8217;étais assis. Cette opération requiert des compétences assez pointues pour obtenir un système fonctionnel.</p>

<p>Et le NoSQL dans tout ça ?</p>

<p>Tug et David vont promettre que cette opération qui nécessitait la présence d&#8217;un administrateur de bases de données très expérimenté va être accessible aux développeurs. Cette promesse sera accompagnée d&#8217;une démonstration :</p>

<ul>
<li>du passage d&#8217;un modèle dit <em>legacy</em> à un modèle moderne <em>REST</em></li>
<li>du passage d&#8217;un modèle SQL à un modèle NoSQL</li>
<li>de distribution de données sur plusieurs <em>noeuds</em></li>
<li>de la mise en place d&#8217;une recherche <em>full text</em> sur des données distribuées</li>
<li>de visualisation des données distribuées suivant des axes configurables</li>
</ul>


<p>L&#8217;intégralité des sources de la démonstration est accessible dans le dépôt Github <a href="https://github.com/dadoonet/sql2nosql/">sql2nosql</a>. La version des sources correspondante à une étape est accessible via les branches du dépôt.</p>

<p>A partir de ce dépôt, je vais effectuer toutes les étapes sur ma machine.</p>

<p>Allons y !</p>

<h2>Récupération des sources</h2>

<p>Je vais commencer par récupérer le contenu de la branche <em>01-legacy/start</em>.</p>

<p>Pour ceux qui voudraient faire autant et qui ne sont pas familier de Github, voici quelques alternatives :</p>

<ul>
<li><p>Télécharger le Zip des sources de la branche <a href="https://github.com/dadoonet/sql2nosql/archive/01-legacy/start.zip">ici</a>.</p></li>
<li><p>Installer <a href="http://git-scm.com/">Git</a> et exécuter les commandes</p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git clone https://github.com/dadoonet/sql2nosql.git
</span><span class='line'>git checkout 01-legacy/start
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><p>Installer le client officiel correspondant à votre OS : <a href="http://windows.github.com/">Windows</a>, <a href="http://mac.github.com/">Mac</a>. Pour linux ? Vous connaissez la chanson, si vous êtes sous linux c&#8217;est que vous ne jurez que par le <em>terminal</em>, faites comme d&#8217;habitude utiliser la ligne de commande ;) Il existe des clients graphiques non officiels mais je n&#8217;ai rien à vous recommander, j&#8217;ai pris l&#8217;habitude de la ligne de commande pour Git même si j&#8217;utilise un client graphique quand il s&#8217;agit de SVN. Il n&#8217;y a pas de raison particulière, question d&#8217;habitude.</p></li>
<li><p>Installer <a href="http://subversion.apache.org/">Subversion</a> et exécuter la commande suivante pour récupérer l&#8217;intégralité des sources. Vous pouvez aussi passer par des clients graphiques comme <a href="http://tortoisesvn.net/">TortoiseSVN</a>. Les sources se trouveront dans le répertoire <em>sql2nosql/branches/01-legacy</em>.</p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>svn co https://github.com/dadoonet/sql2nosql
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Utiliser votre IDE préféré <a href="http://eclipse.org/">Eclipse</a>, <a href="https://netbeans.org/">Netbeans</a>, <a href="http://www.jetbrains.com/idea/">Intellij</a>&#8230;</li>
</ul>


<h2>Exécution de l&#8217;application</h2>

<p>L&#8217;architecture de l&#8217;application repose sur <a href="http://maven.apache.org/">Maven</a>. J&#8217;ai utilisé la version 3.1.1 pour écrire cet article.</p>

<p>Pour exécuter l&#8217;application :</p>

<ul>
<li><p>Si vous êtes sous linux ou Mac, lancer le script <code>run.sh</code></p></li>
<li><p>Si vous êtes sous Windows, lancer les commandes :</p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>mvn clean install
</span><span class='line'><span class="nb">cd </span>demo-webapp
</span><span class='line'>mvn jetty:run
</span></code></pre></td></tr></table></div></figure>


<p>Si l&#8217;application ne parvient pas à récupérer le plugin Maven pour Jetty.
Créer/compléter la configuration du fichier <code>~/.m2/settings.xml</code> dans la section <code>pluginGroups</code> comme ceci :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;settings&gt;</span>
</span><span class='line'>  <span class="nt">&lt;pluginGroups&gt;</span>
</span><span class='line'>    <span class="nt">&lt;pluginGroup&gt;</span>org.eclipse.jetty<span class="nt">&lt;/pluginGroup&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/pluginGroups&gt;</span>
</span><span class='line'><span class="nt">&lt;/settings&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Une fois l&#8217;application démarrée, vous pouvez accéder à la page d&#8217;accueil via l&#8217;adresse : <code>http://localhost:8080</code>. Elle affiche une liste de personnes.</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-1.png"></p>

<p>En cliquant sur une personne, vous avez accès aux détails de la personne sélectionnée.</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-2.png"></p>

<h2>L&#8217;application <em>legacy</em></h2>

<p>Cette application se veut <em>legacy</em>. Elle est pilotée par 2 Servlet:</p>

<ul>
<li><a href="https://github.com/dadoonet/sql2nosql/blob/01-legacy/start/demo-webapp/src/main/java/fr/pilato/demo/sql2nosql/webapp/HomeServlet.java">HomeServlet</a>, gestionnaire de la page d&#8217;accueil.</li>
<li><a href="https://github.com/dadoonet/sql2nosql/blob/01-legacy/start/demo-webapp/src/main/java/fr/pilato/demo/sql2nosql/webapp/PersonServlet.java">PersonServlet</a>, pilote de la page de détail d&#8217;une personne.</li>
</ul>


<p>Le mapping URL/servlet configurés dans le fichier <a href="https://github.com/dadoonet/sql2nosql/blob/01-legacy/start/demo-webapp/src/main/webapp/WEB-INF/web.xml">web.xml</a>.</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-3.png"></p>

<p>Cette application génère l&#8217;intégralité de ses pages côté serveur. Les nouvelles générations d&#8217;applications Web encouragent :</p>

<ul>
<li><p>un Web avec de plus en plus d&#8217;intelligence côté navigateur.</p></li>
<li><p>un Web qui pense &#8220;application web&#8221; avec la même phylosophie qu&#8217;une application mobile. Une application qui s&#8217;installe dans le navigateur.</p></li>
<li><p>un Web qui sépare les univers <em>frontend</em> et <em>backend</em>. Il n&#8217;est plus question de devoir faire un seul choix technologique pour couvrir l&#8217;intégralité de votre besoin. Vous choisissez le meilleur outil pour réaliser votre <em>frontend</em> et vous faites autant pour votre <em>backend</em>. Les deux univers communiquent via HTTP, un protocole particulièrement utile pour faire du web ;)</p></li>
</ul>


<p>En phase avec ces principes, la prochaine étape va consister transformer l&#8217;existant en application <em>backend</em> exposant des services HTTP/REST.</p>

<h2><em>RESTification</em> de l&#8217;application <em>legacy</em></h2>

<p>Pour passer à une architecture REST, commençons par quelque chose de facile : se débarrasser des <em>Servlet</em> de l&#8217;application. Supprimer :</p>

<ul>
<li>Les classes <em>PersonServlet</em> et <em>HomeServlet</em>.</li>
<li>Les fichiers suivants qui ne servent plus à rien <code>demo-webapp/src/main/java/fr/pilato/demo/sql2nosql/webapp/ApplicationInitializer.java</code> et <code>demo-webapp/src/main/java/fr/pilato/demo/sql2nosql/webapp/PersonService.java</code>.</li>
</ul>


<p>L&#8217;objectif à présent avec être de réaliser des services REST. Voici les services à réaliser :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>GET       /api/1/person/  =&gt; Récupérer toutes les personnes
</span><span class='line'>
</span><span class='line'>GET       /api/1/person/{id}  =&gt; Récupérer une personne avec l&#39;identifiant {id}.
</span><span class='line'>
</span><span class='line'>PUT       /api/1/person/  =&gt; Créer une nouvelle personne
</span><span class='line'>
</span><span class='line'>PUT       /api/1/person/{id}  =&gt; Mettre à jour la personne ayant l&#39;identifiant {id}
</span><span class='line'>
</span><span class='line'>DELETE    /api/1/person/{id}  =&gt; Supprimer la personne ayant l&#39;identifiant {id}
</span><span class='line'>
</span><span class='line'>POST      /api/1/person/_search =&gt; Récupérer des personnes suivant un critière
</span><span class='line'>
</span><span class='line'>POST      /api/1/person/_init =&gt; Initialiser la base de données avec des données exemples
</span></code></pre></td></tr></table></div></figure>


<p>Les puristes du REST pourront ne pas être d&#8217;accord avec cette API (l&#8217;utilisation de POST pour effectuer une recherche par critères ou encore l&#8217;utilisation de PUT au lieu de POST pour créer une nouvelle personne) mais ce n&#8217;est pas le sujet, nous allons nous concentrer sur le NoSQL.</p>

<p>L&#8217;application aura l&#8217;architecture suivante :</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-4.png"></p>

<p>La <em>RESTification</em> sera réalisée avec <a href="http://docs.spring.io/spring/docs/4.0.x/spring-framework-reference/html/mvc.html">Spring MVC</a>.</p>

<p>J&#8217;ai mis à jour les fichiers :</p>

<ul>
<li><p><code>pom.xml</code> à la racine du projet comme <a href="https://raw.github.com/dadoonet/sql2nosql/02-restify/begin/pom.xml">ceci</a></p></li>
<li><p><code>demo-webapp/pom.xml</code> comme <a href="https://raw.github.com/dadoonet/sql2nosql/02-restify/begin/demo-webapp/pom.xml">ceci</a></p></li>
<li><p><code>demo-webapp/src/main/webapp/WEB-INF/web.xml</code> pour qu&#8217;il ressemble à celui là : <a href="https://raw.github.com/dadoonet/sql2nosql/02-restify/end/demo-webapp/src/main/webapp/WEB-INF/web.xml">web.xml</a>.</p></li>
</ul>


<p>J&#8217;ai créé le fichier <code>demo-webapp/src/main/java/fr/pilato/demo/sql2nosql/webapp/PersonService.java</code> avec le contenu suivant <a href="https://github.com/dadoonet/sql2nosql/blob/02-restify/end/demo-webapp/src/main/java/fr/pilato/demo/sql2nosql/webapp/PersonService.java">PersonService.java</a>.</p>

<p>Redémarrage de l&#8217;application comme précédemment.</p>

<p>Test du service de récupération de toutes les personnes en accédant à la page suivante via un navigateur moderne : <code>http://localhost:8080/api/1/person/</code>. J&#8217;obtiens :</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-4a.png"></p>

<p>Le résultat <code>[]</code> représente un tableau vide.</p>

<p>Pour initialiser la base de données, il faut utiliser le service</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>POST      /api/1/person/_init
</span></code></pre></td></tr></table></div></figure>


<p>Pour effectuer, une requête avec le verbe HTTP POST, vous avez plusieurs possibilités. Le plus simple en environnement Unix est d&#8217;utiliser la commande <code>curl</code> comme ceci :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>curl -XPOST http://localhost:8080/api/1/person/_init
</span></code></pre></td></tr></table></div></figure>


<p>Sinon vous pouvez installer des extensions pour vos navigateurs comme par exemple <a href="https://chrome.google.com/webstore/detail/simple-rest-client/fhjcajmcbmldlhcimfajhfbgofnpcjmb">Simple REST Client</a> pour Chrome ou encore <a href="https://addons.mozilla.org/en-US/firefox/addon/restclient/">RESTClient</a> pour Firefox.</p>

<p>Une fois les données initialisées, la requête <code>http://localhost:8080/api/1/person/</code> donne le résultat suivant :</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-4b.png"></p>

<p>Il s&#8217;agit un flux JSON représentant 100 personnes.</p>

<p>Il est possible de tester les autres services développés avec ce même principe avec <code>curl</code> ou encore le super outil que vous avez installé.</p>

<h2>Couchbase en action</h2>

<p>Maintenant que la partie Web du <em>backend</em> fonctionne, nous allons commencer à quitter le monde SQL en faisant en sorte d&#8217;utiliser une base NoSQL. L&#8217;heureux élu sera <a href="http://www.couchbase.com/">Couchbase</a>.</p>

<p><a href="http://www.couchbase.com/">Couchbase</a> est une base NoSQL orienté document. Il stocke les données sous la forme &#8220;clé-valeur&#8221;. La clé est une chaine de caractères et la valeur est un document JSON sans aucun schéma pré-défini.</p>

<p>L&#8217;architecture de l&#8217;application va être modifiée comme ceci :</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-5.png"></p>

<p>J&#8217;ai téléchargé la dernière version (2.2.0) <a href="http://www.couchbase.com/download">Couchbase Community Edition</a>.
Je décompresse l&#8217;archive, l&#8217;installe puis lance <a href="http://www.couchbase.com/">Couchbase</a>.</p>

<p>J&#8217;accède à la console d&#8217;administration : <code>http://127.0.0.1:8091/index.html</code> :</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-5a.png"></p>

<p>Et là, sans aucune autre documentation, je me laisse guider en cliquant sur <code>SETUP</code>.</p>

<p>A la page suivante, j&#8217;ai laissé les choix par défaut m&#8217;invitant à créer un nouveau cluster. J&#8217;ai modifié le paramètre <code>Per Server RAM Quota</code> avec la valeur 512 MB au lieu des 3 GB par défaut sur ma machine.</p>

<p>Je laissé les paramètres par défaut et saisis un identifiant/mot de passe administrateur.</p>

<p>Et là, j&#8217;ai l&#8217;écran suivant :</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-5b.png"></p>

<p>J&#8217;ai du rouge. En tant que développeur Java, je suis éduqué pour y voir des erreurs. Je me lance alors dans une tentative de décryptage des couleurs de l&#8217;interface d&#8217;administration :</p>

<ul>
<li><p>Pourquoi la phrase <em>Total Allocated (512 MB)</em> est en rouge ? L&#8217;indicateur de progression est vert, la phrase <em>Unused 512 MB</em> est en vert. Je conclue qu&#8217;il s&#8217;agit probablement d&#8217;un rouge marquant la criticité d&#8217;une ressource et non d&#8217;une erreur.</p></li>
<li><p>Les mots <em>Usable Free Space (O B)</em> en rouge m&#8217;inquiète un peu plus. Là encore, j&#8217;essai de me rassurer en me disant que <a href="http://www.couchbase.com/">Couchbase</a> doit probablement réserver de l&#8217;espace disque progressivement et comme je n&#8217;ai encore aucune donnée, aucun espace disque n&#8217;a encore été réservé.</p></li>
<li><p>La 3ème indication en rouge est <em>Servers Down : 1</em>. J&#8217;ai souvent de l&#8217;imagination pour trouver les bons côtés des choses mais là, je n&#8217;ai aucune inspiration qui me vient. Je dois avoir un problème !</p></li>
</ul>


<p>Alors je clique sur ce message <em>Servers Down : 1</em>.</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-5c.png"></p>

<p>Je décide de laisser en l&#8217;état et de compléter l&#8217;application pour voir si le client Couchbase a des difficultés à se connecter avec ce <em>Server Down : 1</em> ;)</p>

<p>Pour communiquer avec Couchbase depuis l&#8217;application, nous allons utiliser la bibliothèque <a href="http://files.couchbase.com/maven2/couchbase/couchbase-client/">couchbase-client</a> accessible via le repository Maven de Couchbase <a href="http://files.couchbase.com/maven2/">http://files.couchbase.com/maven2/</a>. Il faudrait donc modifier le fichier <code>demo-webapp/pom.xml</code> comme <a href="https://raw.github.com/dadoonet/sql2nosql/03-couchbase-persistence/begin/demo-webapp/pom.xml">ceci</a> pour  ajouter la dépendance vers la librairie <a href="http://files.couchbase.com/maven2/couchbase/couchbase-client/">couchbase-client</a>.</p>

<p>Ce client est simple d&#8217;utilisation, voici un exemple d&#8217;utilisation :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">// Création de la liste des différents noeuds Couchbase</span>
</span><span class='line'><span class="n">List</span><span class="o">&lt;</span><span class="n">URI</span><span class="o">&gt;</span> <span class="n">nodes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">URI</span><span class="o">&gt;();</span>
</span><span class='line'><span class="n">nodes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">&quot;http://127.0.0.1:8091/pools&quot;</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Création du client</span>
</span><span class='line'><span class="n">CouchbaseClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CouchbaseClient</span><span class="o">(</span><span class="n">nodes</span><span class="o">,</span> <span class="s">&quot;default&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Récupération d&#39;une donnée dont la clé est &quot;MA_CLE&quot;</span>
</span><span class='line'><span class="n">String</span> <span class="n">person</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">client</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;MA_CLE&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Créer le fichier <code>demo-webapp/src/main/java/fr/pilato/demo/sql2nosql/webapp/util/ConnectionManager.java</code> avec <a href="https://raw.github.com/dadoonet/sql2nosql/03-couchbase-persistence/end/demo-webapp/src/main/java/fr/pilato/demo/sql2nosql/webapp/util/ConnectionManager.java">ce contenu</a>.</p>

<p>Créer le fichier <code>demo-webapp/src/main/java/fr/pilato/demo/sql2nosql/webapp/util/KeyUtil.java</code> avec <a href="https://raw.github.com/dadoonet/sql2nosql/03-couchbase-persistence/end/demo-webapp/src/main/java/fr/pilato/demo/sql2nosql/webapp/util/KeyUtil.java">ce contenu</a></p>

<p>Créer le fichier <code>demo-webapp/src/main/java/fr/pilato/demo/sql2nosql/webapp/util/ViewUtil.java</code> avec <a href="https://raw.github.com/dadoonet/sql2nosql/03-couchbase-persistence/end/demo-webapp/src/main/java/fr/pilato/demo/sql2nosql/webapp/util/ViewUtil.java">ce contenu</a></p>

<p>Compléter le fichier <code>demo-webapp/src/main/java/fr/pilato/demo/sql2nosql/webapp/PersonService.java</code> <a href="https://raw.github.com/dadoonet/sql2nosql/03-couchbase-persistence/end/demo-webapp/src/main/java/fr/pilato/demo/sql2nosql/webapp/PersonService.java">ce contenu</a>.</p>

<p>Redémarrer l&#8217;application.</p>

<p>J&#8217;obtiens une jolie stacktrace. Ah voilà quelque chose qui me parle !</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Caused</span> <span class="nl">by:</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">beans</span><span class="o">.</span><span class="na">BeanInstantiationException</span><span class="o">:</span> <span class="n">Could</span> <span class="n">not</span> <span class="n">instantiate</span> <span class="n">bean</span> <span class="kd">class</span> <span class="err">[</span><span class="nc">fr</span><span class="o">.</span><span class="na">pilato</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">sql2nosql</span><span class="o">.</span><span class="na">webapp</span><span class="o">.</span><span class="na">PersonService</span><span class="o">]:</span> <span class="n">Constructor</span> <span class="n">threw</span> <span class="n">exception</span><span class="o">;</span> <span class="n">nested</span> <span class="n">exception</span> <span class="n">is</span> <span class="n">com</span><span class="o">.</span><span class="na">couchbase</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">vbucket</span><span class="o">.</span><span class="na">config</span><span class="o">.</span><span class="na">ConfigParsingException</span><span class="o">:</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">buckets</span> <span class="n">must</span> <span class="n">be</span> <span class="n">a</span> <span class="n">power</span> <span class="n">of</span> <span class="n">two</span><span class="o">,</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">and</span> <span class="o">&lt;=</span> <span class="mi">65536</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">beans</span><span class="o">.</span><span class="na">BeanUtils</span><span class="o">.</span><span class="na">instantiateClass</span><span class="o">(</span><span class="n">BeanUtils</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">163</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">beans</span><span class="o">.</span><span class="na">factory</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">SimpleInstantiationStrategy</span><span class="o">.</span><span class="na">instantiate</span><span class="o">(</span><span class="n">SimpleInstantiationStrategy</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">87</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">beans</span><span class="o">.</span><span class="na">factory</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">AbstractAutowireCapableBeanFactory</span><span class="o">.</span><span class="na">instantiateBean</span><span class="o">(</span><span class="n">AbstractAutowireCapableBeanFactory</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1004</span><span class="o">)</span>
</span><span class='line'>  <span class="o">...</span> <span class="mi">54</span> <span class="n">more</span>
</span><span class='line'><span class="n">Caused</span> <span class="nl">by:</span> <span class="n">com</span><span class="o">.</span><span class="na">couchbase</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">vbucket</span><span class="o">.</span><span class="na">config</span><span class="o">.</span><span class="na">ConfigParsingException</span><span class="o">:</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">buckets</span> <span class="n">must</span> <span class="n">be</span> <span class="n">a</span> <span class="n">power</span> <span class="n">of</span> <span class="n">two</span><span class="o">,</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">and</span> <span class="o">&lt;=</span> <span class="mi">65536</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">couchbase</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">vbucket</span><span class="o">.</span><span class="na">config</span><span class="o">.</span><span class="na">DefaultConfigFactory</span><span class="o">.</span><span class="na">parseEpJSON</span><span class="o">(</span><span class="n">DefaultConfigFactory</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">135</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Euh finalement, ça ne me parle pas tant que ça ;)</p>

<p>Je porte mon attention sur le message d&#8217;erreur <em>Number of buckets must be a power of two, > 0 and &lt;= 65536</em>. Après plusieurs investigations dans différents forums <a href="http://www.couchbase.com/forums/thread/number-buckets-must-be-power-two-0-and-0">là</a>, <a href="http://www.couchbase.com/forums/thread/number-buckets-must-be-power-two">là</a>, ou encore <a href="http://www.couchbase.com/issues/browse/MB-8332">là</a>. Je croise même un message de <a href="tugdual_grall">Tugdual</a> dans ces fils de discussion ;)</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-5d.png"></p>

<p>Après avoir cliqué sur tous les menus et tous les boutons de l&#8217;interface d&#8217;administration, je ne parviens toujours pas à avancer. J&#8217;ai réussi au passage à me débarrasser du message d&#8217;avertissement <em>Fail Over Warning : At least two servers are required to provide replication!</em> en supprimant et recréant un <em>bucket</em>. Je comprends que j&#8217;ai eu ce message d&#8217;erreur car lors de l&#8217;initialisation de Couchbase, la case à cocher <em>Replicate</em> est cochée par défaut. Par contre impossible de me débarrasser de l&#8217;erreur <em>Server Down : 1</em>.</p>

<p>J&#8217;ai essayé une version plus récente du client. Je remarque au passage que le client couchbase-client est disponible en fait dans le Repo Maven Central via la dépendance :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>com.couchbase.client<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>couchbase-client<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>1.2.2<span class="nt">&lt;/version&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Quoiqu&#8217;il en soit, cela ne résoud pas le problème !</p>

<p>Je décide alors de recommencer l&#8217;installation. Je n&#8217;ai pas trouvé un moyen de revenir à l&#8217;état initial via l&#8217;interface d&#8217;administration. J&#8217;arrête le serveur, je supprime tous les fichiers générés par Couchbase puis je démarre <a href="http://www.couchbase.com/">Couchbase</a>. Cette fois-ci je choisis 1024 MB pour la RAM, je désactive la réplication et je sélectionne un échantillon de données (<em>beer</em>). Et là, c&#8217;est magique plus de <em>Server Down : 1</em> !</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-5e.png"></p>

<p>Je redémarre l&#8217;application, plus d&#8217;exception !</p>

<p>Rechargement des données</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>curl -XPOST http://localhost:8080/api/1/person/_init
</span></code></pre></td></tr></table></div></figure>


<p>Les données sont accessibles via l&#8217;url <code>http://localhost:8080/api/1/person/</code>.</p>

<p>Dans l&#8217;interface d&#8217;administration, à l&#8217;onglet <em>View</em>, il y a une vue <em>by_name</em> qui permet de visualiser quelques données. Oui les données ont bien été insérées dans <a href="http://www.couchbase.com/">Couchbase</a>.</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-5f.png"></p>

<h2>Les écrans avec AngularJS et Twitter Bootstrap</h2>

<p>Nous avons jusqu&#8217;à présent un backend qui renvoie des données au format JSON. Cette étape va consister à recréer les vues que nous avions au départ.</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-6.png"></p>

<p>Pour ne pas trop alourdir cet article, je ne vais pas faire un cours sur AngularJS qui n&#8217;est pas le sujet principal de cette session ;)</p>

<p>Vous pouvez directement retrouver les sources dans la branche <code>04-angular/end</code> ou bien les télécharger directement <a href="https://github.com/dadoonet/sql2nosql/archive/04-angular/end.zip">ici</a>.</p>

<p>Redémarrer l&#8217;application.</p>

<p>Les écrans sont de retour.</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-6a.png"></p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-6b.png"></p>

<p>Il n&#8217;est pour le moment possible que d&#8217;effectuer des recherches par nom.</p>

<h2>La recherche <em>full text</em></h2>

<p>La recherche <em>full text</em> va être implémentée avec <a href="http://www.elasticsearch.org/">Elasticsearch</a>. L&#8217;idée principale est d&#8217;avoir les données répliquées de <a href="http://www.couchbase.com/">Couchbase</a> à <a href="http://www.elasticsearch.org/">Elasticsearch</a> qui va les indéxer. L&#8217;application <em>front end</em>, pour rechercher les données, va directement intéroger <a href="http://www.elasticsearch.org/">Elasticsearch</a>.</p>

<p>Nous aurons à la fin de cette étape, l&#8217;architecture suivante :</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-7.png"></p>

<p>Je télécharge <a href="https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-0.90.2.zip">Elasticsearch v0.90.2</a> et décompresser l&#8217;archive dans le répertoire de votre choix.</p>

<p>J&#8217;installe le plugin Couchbase pour <a href="http://www.elasticsearch.org/">Elasticsearch</a> (version 1.1.0) via l&#8217;exécutable <code>bin/plugin(.bat)</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>bin/plugin -install transport-couchbase -url http://packages.couchbase.com.s3.amazonaws.com/releases/elastic-search-adapter/1.1.0/elasticsearch-transport-couchbase-1.1.0.zip
</span></code></pre></td></tr></table></div></figure>


<p>Dans le fichier <code>config/elasticsearch.yml</code>, je renseigne les paramètres :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>couchbase.username: Administrator
</span><span class='line'>couchbase.password: Administrator
</span><span class='line'>couchbase.maxConcurrentRequests: 256
</span></code></pre></td></tr></table></div></figure>


<p>Je démarre <a href="http://www.elasticsearch.org/">Elasticsearch</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>bin/elasticsearch -f
</span></code></pre></td></tr></table></div></figure>


<p>Je crée un template <a href="http://www.elasticsearch.org/">Elasticsearch</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>curl -XPUT http://localhost:9200/_template/couchbase -d <span class="s1">&#39;</span>
</span><span class='line'><span class="s1">{</span>
</span><span class='line'><span class="s1">    &quot;template&quot; : &quot;*&quot;,</span>
</span><span class='line'><span class="s1">    &quot;order&quot; : 10,</span>
</span><span class='line'><span class="s1">    &quot;mappings&quot; : {</span>
</span><span class='line'><span class="s1">        &quot;couchbaseCheckpoint&quot; : {</span>
</span><span class='line'><span class="s1">            &quot;_source&quot; : {</span>
</span><span class='line'><span class="s1">                &quot;includes&quot; : [&quot;doc.*&quot;]</span>
</span><span class='line'><span class="s1">            },</span>
</span><span class='line'><span class="s1">            &quot;dynamic_templates&quot;: [</span>
</span><span class='line'><span class="s1">                {</span>
</span><span class='line'><span class="s1">                    &quot;store_no_index&quot;: {</span>
</span><span class='line'><span class="s1">                        &quot;match&quot;: &quot;*&quot;,</span>
</span><span class='line'><span class="s1">                        &quot;mapping&quot;: {</span>
</span><span class='line'><span class="s1">                            &quot;store&quot; : &quot;no&quot;,</span>
</span><span class='line'><span class="s1">                            &quot;index&quot; : &quot;no&quot;,</span>
</span><span class='line'><span class="s1">                            &quot;include_in_all&quot; : false</span>
</span><span class='line'><span class="s1">                        }</span>
</span><span class='line'><span class="s1">                    }</span>
</span><span class='line'><span class="s1">                }</span>
</span><span class='line'><span class="s1">            ]</span>
</span><span class='line'><span class="s1">        },</span>
</span><span class='line'><span class="s1">        &quot;_default_&quot; : {</span>
</span><span class='line'><span class="s1">            &quot;properties&quot; : {</span>
</span><span class='line'><span class="s1">                &quot;meta&quot; : {</span>
</span><span class='line'><span class="s1">                    &quot;type&quot; : &quot;object&quot;,</span>
</span><span class='line'><span class="s1">                    &quot;enabled&quot; : false</span>
</span><span class='line'><span class="s1">                }</span>
</span><span class='line'><span class="s1">            }</span>
</span><span class='line'><span class="s1">        }</span>
</span><span class='line'><span class="s1">    }</span>
</span><span class='line'><span class="s1">}</span>
</span><span class='line'><span class="s1">&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Je crée un index pour person.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>curl -XPUT http://localhost:9200/person
</span></code></pre></td></tr></table></div></figure>


<p>Je reviens à l&#8217;interface d&#8217;administration Couchbase : <code>http://127.0.0.1:8091/index.html</code>.</p>

<p>Je clique sur l&#8217;onglet XDCR.</p>

<p>Je crée un cluster de référence avec le bouton <code>Create Cluster Reference</code>.</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-7a.png"></p>

<p>Je crée une réplication avec le bouton <code>Create Replication</code>.</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-7b.png"></p>

<p>Et là dans mon cas, ça n&#8217;a pas fonctionné.</p>

<p>Après quelques recherches, je suis tombé sur <a href="https://github.com/couchbaselabs/elasticsearch-transport-couchbase/issues/3">cette fil de discussion</a> qui conseille l&#8217;utilisation de la version 1.2.0 du plugin pour ma version de <a href="http://www.couchbase.com/">Couchbase</a>.</p>

<p>Je désinstalle de l&#8217;ancienne version du plugin.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>bin/plugin -remove transport-couchbase
</span></code></pre></td></tr></table></div></figure>


<p>J&#8217;installe la version 1.2.0 du plugin.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>bin/plugin -install transport-couchbase -url http://packages.couchbase.com.s3.amazonaws.com/releases/elastic-search-adapter/1.2.0/elasticsearch-transport-couchbase-1.2.0.zip
</span></code></pre></td></tr></table></div></figure>


<p>Je réessaie de créer la réplication et j&#8217;ai toujours la même erreur. Côté <a href="http://www.elasticsearch.org/">Elasticsearch</a>, je peux lire l&#8217;exception suivante dans les logs :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>013-11-23 02:30:02,779<span class="o">][</span>WARN <span class="o">][</span>org.eclipse.jetty.servlet.ServletHandler<span class="o">]</span> Error <span class="k">for</span> /pools/default/buckets
</span><span class='line'>java.lang.NoSuchMethodError: org.elasticsearch.cluster.metadata.MetaData.getIndices<span class="o">()</span>Ljava/util/Map;
</span><span class='line'>  at org.elasticsearch.transport.couchbase.capi.ElasticSearchCouchbaseBehavior.getBucketsInPool<span class="o">(</span>ElasticSearchCouchbaseBehavior.java:82<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Je comprends que ma version d&#8217;<a href="http://www.elasticsearch.org/">Elasticsearch</a> n&#8217;est pas compatible avec la nouvelle version du plugin.</p>

<p>J&#8217;ai trouvé le tableau de compatibilité suivant qui rend clair tous mes problèmes d&#8217;incompatibilité accessible <a href="https://github.com/couchbaselabs/elasticsearch-transport-couchbase">ici</a> :</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-7c.png"></p>

<p><a href="tugdual_grall">Tugdual</a> et <a href="david_pilato">David</a> ont travaillé sur la ligne Plugin=1.1.0, Couchbase=2.0, ElasticSearch=0.90.2.</p>

<p>Vu que j&#8217;ai une base <a href="http://www.couchbase.com/">Couchbase</a> qui fonctionne et que comme tout développeur j&#8217;aime bien les dernières versions, je vais télécharger <a href="https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-0.90.5.zip">ElasticSearch 0.90.5</a> et recommencer l&#8217;installation.</p>

<p>J&#8217;obtiens toujours la même erreur lors de la création de la réplication même avec les dernières versions. Par un geste de désespoir je supprime et recrée le cluster de référence. Et là, la création de la réplication se fait sans problème !</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-7d.png"></p>

<p>Mais&#8230; Il y a un petit message que je n&#8217;ai pas envie de voir <em>Last 10 errors</em>. Je clique sur ce message de couleur bleu.</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-7e.png"></p>

<p>Là je ne sais pas trop quoi penser ;) La réplication ne se passe visiblement pas bien.</p>

<p>Je décide de faire une courte pause, de télécharger la version 2.0.0 de Couchbase et de revenir à la version 0.90.2 d&#8217;<a href="http://www.elasticsearch.org/">Elasticsearch</a>.</p>

<p>Je démarre la version 2.0.0 de <a href="http://www.couchbase.com/">Couchbase</a>, elle rentre en conflit avec ma version 2.2.0 installée précédemment car elles partagent le même répertoire de travail. Je déplace ce répertoire de travail et là plus de problème.</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-7f.png"></p>

<p>Je réinjecte les données :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>curl -XPOST http://localhost:8080/api/1/person/_init
</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-7g.png"></p>

<p>Les données sont bien répliquées, on est passé de 1001 à 2001 comme prévu.</p>

<p>Le client AngularJS sera modifié pour interroger directement <a href="http://www.elasticsearch.org/">Elasticsearch</a> pour la fonctionnalité de recherche. <a href="http://www.elasticsearch.org/">Elasticsearch</a> expose une API REST pour rechercher des données. Pour rechercher les personnes ayant &#8216;Alix&#8217; dans leur nom ou prénom, il suffit d&#8217;accéder à l&#8217;adresse : <code>http://127.0.0.1:9200/person/_search?q=alix</code>.</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-7h.png"></p>

<h2>Vos tableaux de bord les doigts dans le nez avec Kibana</h2>

<p><a href="http://www.elasticsearch.org/overview/kibana/">Kibana</a> est une application web qui permet de visualiser les données indexées dans <a href="http://www.elasticsearch.org/">Elasticsearch</a> suivant des critères.</p>

<p>A l&#8217;issue de cette étape, l&#8217;architecture de l&#8217;application va ressembler à ceci :</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-8.png"></p>

<p>J&#8217;installe le plugin Kibana pour <a href="http://www.elasticsearch.org/">Elasticsearch</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>bin/plugin -install elasticsearch/kibana
</span></code></pre></td></tr></table></div></figure>


<p>En lançant <a href="http://www.elasticsearch.org/overview/kibana/">Kibana</a>, <code>http://localhost:9200/_plugin/kibana/</code>, j&#8217;obtiens ceci :</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-8a.png"></p>

<p>Je choisis de ne pas tenter l&#8217;aventure de la mise à jour. Je clique sur le lien <code>src</code> et j&#8217;accède à une page d&#8217;introduction.</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-8b.png"></p>

<p>Je clique sur <code>Sample Dashboard</code>.</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-8c.png"></p>

<p>Il est possible de filtrer, visualiser les données suivant plusieurs axes d&#8217;analyse. Si vous souhaitez jouer avec <a href="http://www.elasticsearch.org/overview/kibana/">Kibana</a>, il y a une démo en ligne accessible à l&#8217;adresse <a href="http://demo.kibana.org/#/dashboard">http://demo.kibana.org/#/dashboard</a> :</p>

<p><img class="center" src="/images/nantesjug/nov13/nantesjug-nov13-demo-8d.png"></p>

<h2>Les slides de Devoxx Belgique 2013</h2>

<script async class="speakerdeck-embed" data-id="95cfa1f02edb0131128806fa6ec08ea7" data-ratio="1.72972972972973" src="//speakerdeck.com/assets/embed.js"></script>


<h2>Et pour conclure ?</h2>

<p>Comme vous l&#8217;avez surement constaté, cette soirée du JUG Nantes a été riche en contenu.</p>

<p>Dans le monde des bases de données NoSQL orientées document, <a href="http://www.couchbase.com/">Couchbase</a> a un concurrent direct <a href="http://www.mongodb.org/">MongoDB</a>. Un participant va poser la question de savoir quelles étaient les différences de fond entre ces deux bases de données. <a href="https://twitter.com/tgrall">Tugdual</a>, évangéliste <a href="http://www.couchbase.com/">Couchbase</a>, va donner les éléments de réponse suivants :</p>

<ul>
<li><p><a href="http://www.couchbase.com/">Couchbase</a> est conçu pour faciliter la distribution des données, la création de nombreux clusters de données via une interface d&#8217;administration. Il est donc plus indiqué pour des systèmes nécessitant de traitement de grand volumes de données distribuées sur plusieurs machine. Créer un cluster avec <a href="http://www.mongodb.org/">MongoDB</a> ne serait pas une tâche aussi simple que dans <a href="http://www.couchbase.com/">Couchbase</a>.</p></li>
<li><p><a href="http://www.mongodb.org/">MongoDB</a> est plus riche et plus facile à requêter que <a href="http://www.couchbase.com/">Couchbase</a>. Il dispose d&#8217;une API très puissante pour extraire des données. C&#8217;est pour cette raison qu&#8217;il est conseillé de coupler <a href="http://www.couchbase.com/">Couchbase</a> à <a href="http://www.elasticsearch.org/">Elasticsearch</a> pour disposer d&#8217;une plus grande puissance d&#8217;extraction/analyse de données.</p></li>
</ul>


<p>Au regard de la complémentarité des deux technologies (<a href="http://www.couchbase.com/">Couchbase</a> &amp; <a href="http://www.elasticsearch.org/">Elasticsearch</a>), on peut se demander <em>A quand le rachat de l&#8217;un par l&#8217;autre ?</em>. <a href="https://twitter.com/dadoonet">David</a> va affirmer, hors séance, que ce n&#8217;était pas à sa connaissance à l&#8217;ordre du jour. Il y voit en <a href="http://www.elasticsearch.org/">Elasticsearch</a> un produit complet au point que certains clients n&#8217;hésiteraient pas à l&#8217;utiliser directement en tant que base de données.</p>

<p>Bien évidemment, si vous souhaitez mettre en oeuvre ces outils, prenez des versions compatibles entre elles et n&#8217;hésitez pas à recommencer quand vous êtes dans une impasse ;)</p>

<p>Je ne sais pas pour vous mais je suis impatient d&#8217;être à la prochaine soirée du JUG Nantes : <a href="http://nantesjug.org/#/events/2013_12_04">Grails dans les tranchés + Java 8</a>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Rossi Oddet</span></span>

      








  


<time datetime="2013-11-21T09:30:00-05:00" pubdate data-updated="true">Nov 21<span>st</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/jugnantes/'>jugnantes</a>, <a class='category' href='/blog/categories/jugnantesnov/'>jugnantesnov</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://roddet.github.com/2013/11/nantesjug-novembre-part2/" data-via="rossioddet" data-counturl="http://roddet.github.com/2013/11/nantesjug-novembre-part2/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2013/11/nantesjug-novembre-part1/" title="Previous Post: Soirée JUG Nantes : Du SQL au NoSQL en moins d'une heure (Partie 1)">&laquo; Soirée JUG Nantes : Du SQL au NoSQL en moins d'une heure (Partie 1)</a>
      
      
        <a class="basic-alignment right" href="/2013/12/nantesjs-gruntjs/" title="Next Post: Soirée NantesJS : Découverte de GruntJS">Soirée NantesJS : Découverte de GruntJS &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Rossi Oddet</h1>
  <br/>
  <table>
  	<tr><td width="30%"><img src="/images/photo.jpeg" width="75"/></td>
  		<td>&nbsp;&nbsp;</td>
    <td width="70%"> <p>Développeur, Blogger et passionné par les communautés IT.</p></td></tr>
</table>
</section>
<a class="twitter-timeline" href="https://twitter.com/rossioddet" data-widget-id="314511007521312768">Tweets by @rossioddet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Rossi Oddet -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blogroddet';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://roddet.github.com/2013/11/nantesjug-novembre-part2/';
        var disqus_url = 'http://roddet.github.com/2013/11/nantesjug-novembre-part2/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
